# v2.2.2 Plan — Text Chat Widget Admin Improvements

## 1. Custom Model Option in Model Selector

**Goal**: Allow users to enter any model name manually, enabling OpenAI-compatible providers (Google Gemini, Anthropic via proxy, local models, etc.) alongside the existing presets.

### Current State
- `SaveWidgetForm.jsx` has a `<select>` with hardcoded model options (GPT 5.2, GPT 5 Mini, GPT 4.1 Mini)
- `tw_chat_ai_model` stored as post meta string
- `SettingsManager.jsx` already has an **API Base URI** field for custom endpoints
- PHP reads model via `$chat_widget['tw_chat_ai_model']` and passes it directly to the OpenAI client — no validation against a whitelist

### Implementation

#### React (`SaveWidgetForm.jsx`)
- Add a `"custom"` option to the model `<select>`: `<option value="custom">Custom</option>`
- When `"custom"` is selected, show a text input below the dropdown for the model name
- New state field: `tw_chat_ai_model_custom` (only used when model is `"custom"`)
- On form submit: if model is `"custom"`, use the custom text field value as `tw_chat_ai_model`
- On load: if the stored model doesn't match any preset option, set select to `"custom"` and populate the text field
- Update description text: "Select a model or choose Custom to enter any OpenAI-compatible model name."

#### PHP
- No changes needed — PHP already passes the model string directly to the OpenAI client
- The API Base URI setting already supports custom endpoints

#### CSS (`Admin.css`)
- Style the conditional custom model text input if needed

---

## 2. Webhook Data Structure UI

**Goal**: Provide a visual field builder so users can define the expected webhook payload structure without writing it in the system prompt. The plugin auto-injects the structure into the prompt at runtime.

### Current State
- Webhook tool sends a single `data` string parameter to the configured URL
- Users must describe the expected data format in their system prompt manually
- `TW_Chat_Prompt_Manager` handles prompt assembly with constants and `inject_params()`
- Webhook address and header stored as widget post meta

### Implementation

#### React (`SaveWidgetForm.jsx`)
- Add a **Webhook Data Structure** section below the webhook address/header fields (visible when webhook address is not empty)
- UI: A repeatable field builder where each row has:
  - **Field Name** (text input, e.g., `name`, `email`, `phone`)
  - **Type** dropdown (`string`, `number`, `email`, `boolean`)
  - **Required** checkbox
  - **Description** (text input, e.g., "Customer's full name")
  - Remove button (trash icon)
- "Add Field" button to add new rows
- Store as JSON string in new post meta: `tw_chat_webhook_schema`
- Example stored value:
  ```json
  [
    { "name": "name", "type": "string", "required": true, "description": "Customer's full name" },
    { "name": "email", "type": "email", "required": true, "description": "Customer's email address" },
    { "name": "phone", "type": "string", "required": false, "description": "Phone number" }
  ]
  ```

#### New React Component (`WebhookSchemaBuilder.jsx`)
- Reusable component in `admin/app/src/components/`
- Props: `value` (JSON string), `onChange` (callback)
- Renders the repeatable field rows
- Handles add/remove/reorder

#### PHP — Dynamic Tool Definition (`class-tw-chat-functions.php`)

**Critical compatibility requirement**: The webhook tool's OpenAI function schema must reflect the user-defined fields so the model sends structured JSON — not just a generic string.

Current tool definition:
```php
"name" => "webhook",
"parameters" => [
    "properties" => [
        "data" => [ "type" => "string", "description" => "Data to send to the external URL." ]
    ]
]
```

Updated approach:
- `get_function_definitions()` gains an optional `$widget_id` parameter
- When `tw_chat_webhook_schema` meta exists for the widget, the webhook tool's `data` parameter description is updated to include the expected JSON structure:
  ```
  Data to send as a JSON object with these fields: name (string, required) - Customer's full name, email (email, required) - Email address, phone (string, optional) - Phone number
  ```
- This ensures the model knows the exact structure at the **tool-call level**, not just from the system prompt
- Call site in `class-tw-chat.php` updated: `TW_Chat_Functions::get_function_definitions($widget_id)`

#### PHP — Webhook Handler Update (`class-tw-chat-functions.php`)

Current handler issue: `sanitize_text_field()` on line 220 strips JSON structure. Update:
- Replace `sanitize_text_field($arguments[$param_name])` with `wp_kses_post($arguments[$param_name])` or direct JSON validation
- Add `Content-Type: application/json` header to `wp_remote_post` args by default when schema is defined
- Validate that the received JSON contains all required fields from the schema before posting

#### PHP — Prompt Injection (`TW_Chat_Prompt_Manager`)
- New constant `PROMPT_WEBHOOK_SCHEMA` with template:
  ```
  ## Webhook Data Structure

  When using the webhook tool, format the data as a JSON object with the following fields:
  {field_definitions}

  Always collect all required fields before sending the webhook. Send the data as a valid JSON string.
  ```
- New method `get_webhook_schema_prompt($schema)` that:
  - Parses the JSON schema array
  - Formats each field as a readable line: `- name (string, required): Customer's full name`
  - Injects into the template
- Returns empty string if schema is empty

#### PHP — Prompt Assembly (`class-tw-chat.php`)
- After site search prompt injection, check for `tw_chat_webhook_schema` meta
- If present, append `TW_Chat_Prompt_Manager::get_webhook_schema_prompt($schema)` to system prompt
- Update `get_function_definitions()` call to pass `$widget_id`

#### PHP — Admin (`class-tw-chat-admin.php`)
- Register `tw_chat_webhook_schema` in `register_setting`, `get_plugin_settings`, `delete_option`, and `update_option` calls

#### CSS (`Admin.css`)
- Styles for the schema builder rows (field grid, add/remove buttons)

---

## 3. AI Prompt Generator

**Goal**: Help users write effective system prompts by providing an AI-powered generator. The user describes what they want in plain language, and the plugin generates a well-structured system prompt.

### Current State
- System prompt is a plain `<textarea>` in `SaveWidgetForm.jsx`
- No AI assistance for prompt writing
- Plugin has OpenAI API key available in global settings

### Implementation

#### React (`SaveWidgetForm.jsx`)
- Add a "Generate with AI" button next to or below the system prompt textarea
- Clicking opens a modal/panel with:
  - A text input: "Describe what you want your chatbot to do" (e.g., "Answer questions about our dental practice and help schedule appointments")
  - Optional context checkboxes that auto-include relevant info:
    - "Uses site search" (checked if site search is enabled)
    - "Uses webhook" (checked if webhook is configured)
    - "Has suggested answers" (checked if suggested answers exist)
  - "Generate" button
  - Loading state while API call is in progress
- On response: show the generated prompt in a preview area
- User can "Apply" (replaces textarea content), "Refine" (sends follow-up), or "Cancel"
- If the textarea already has content, offer "Improve existing prompt" option that sends the current prompt for refinement

#### New React Component (`PromptGenerator.jsx`)
- Modal component in `admin/app/src/components/`
- Props: `currentPrompt`, `widgetConfig` (to know which tools are enabled), `onApply`, `onClose`
- Manages its own conversation state for refinement

#### PHP — New AJAX Endpoint
- New action: `tw_chat_generate_prompt`
- Accepts: `description` (string), `current_prompt` (optional string), `context` (object with tool flags)
- Uses the site's OpenAI API key to call the API with a meta-prompt that instructs it to generate a system prompt
- Meta-prompt includes:
  - Instructions to write a clear, structured system prompt
  - Context about available tools (site search, webhook, wp_action)
  - The user's description
  - The current prompt if refining
- Returns: generated prompt text

#### CSS (`Admin.css`)
- Modal styles for the prompt generator
- Loading spinner, preview area, action buttons

---

## File Change Summary

| File | Changes |
|---|---|
| `admin/app/src/components/SaveWidgetForm.jsx` | Custom model selector, webhook schema builder integration, prompt generator button |
| `admin/app/src/components/WebhookSchemaBuilder.jsx` | **New** — Repeatable field builder component |
| `admin/app/src/components/PromptGenerator.jsx` | **New** — AI prompt generation modal |
| `admin/app/src/Admin.css` | Styles for schema builder, prompt generator modal, custom model input |
| `admin/class-tw-chat-admin.php` | Register `tw_chat_webhook_schema` meta, new `generate_prompt` AJAX endpoint |
| `includes/class-tw-chat-prompt-manager.php` | New `PROMPT_WEBHOOK_SCHEMA` constant and `get_webhook_schema_prompt()` method |
| `includes/class-tw-chat.php` | Inject webhook schema prompt into system prompt assembly |

## Implementation Order

1. **Custom model selector** — smallest scope, no new files, no PHP changes
2. **Webhook data structure UI** — new component + PHP prompt injection
3. **AI prompt generator** — new component + new AJAX endpoint
