# v2.2.3 Plan — API Security & Tool Call Migration

## 1. Improve Security of API Endpoints

**Goal**: Harden the public-facing REST API endpoints (`/chat` and `/create-call`) against abuse. Currently both endpoints have `permission_callback => true` with no nonce verification, rate limiting, or origin validation.

### Current State
- `register_rest_endpoints()` registers two routes with open `permission_callback`
- The chat widget frontend sends `X-WP-Nonce` header but the backend never verifies it
- No rate limiting — endpoints can be called unlimited times
- No origin validation — any external client can call the endpoints
- `handle_create_call()` does not sanitize `agent_id` input

### Implementation

#### 1a. Nonce Verification on REST Endpoints
- Update `permission_callback` for both `/chat` and `/create-call` to verify the WP REST nonce
- Use `wp_verify_nonce()` against the `wp_rest` nonce action that the frontend already sends
- This ensures only requests originating from the WordPress site are accepted

#### 1b. Rate Limiting
- Add transient-based rate limiting per IP address to the `/chat` endpoint
- Default: 20 requests per minute per IP
- Use `get_transient()` / `set_transient()` with IP-based keys
- Return `429 Too Many Requests` when exceeded

#### 1c. Input Sanitization on Create Call
- Sanitize `agent_id` parameter in `handle_create_call()` with `sanitize_text_field()`

### Files Changed
| File | Changes |
|---|---|
| `includes/class-tw-chat.php` | Nonce verification in `permission_callback`, rate limiting in `handle_chat_response`, sanitize `agent_id` |

---

## 2. Update Function Call to Tool Call

**Goal**: Migrate from the deprecated OpenAI `functions`/`function_call` API format to the modern `tools`/`tool_choice` format. This is required for compatibility with non-OpenAI providers (Google Gemini, etc.) and follows OpenAI's current recommended approach.

### Changes Made
- `get_function_definitions()` updated to return `tools` format (each function wrapped in `{type: 'function', function: {...}}`)
- Chat completion request uses `tools`/`tool_choice` parameters instead of `functions`/`function_call`
- Response handling reads `$message->toolCalls` instead of `$message->functionCall`
- Follow-up messages use `role: tool` with `tool_call_id` instead of `role: function`
- Removed Guzzle response logging middleware (debug-only)
- Removed `API Base URI` setting from PHP backend and admin UI
- Cleaned up all remaining references to legacy `function_call` format

### Files Changed
| File | Changes |
|---|---|
| `includes/class-tw-chat.php` | Tool call migration, removed API base URI, removed Guzzle middleware |
| `includes/class-tw-chat-functions.php` | Wrapped definitions in tools format |
| `admin/class-tw-chat-admin.php` | Removed `tw_chat_api_base_uri` from settings registration, deletion, retrieval, and saving |
| `admin/app/src/pages/SettingsManager.jsx` | Removed API Base URI field and note from UI |
| `admin/app/src/components/SaveWidgetForm.jsx` | Removed API Base URI reference from custom model description |
| `widgets/voice-widget/src/VoiceWidget.js` | Added nonce header and localized API URL for create-call endpoint |
